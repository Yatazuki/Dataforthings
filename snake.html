<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Snake Game - Yatazuki</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="navbar.css">
  <link rel="stylesheet" href="snake.css">
</head>
<body>
  <!-- Navbar will be inserted by navbar.js -->

  <div class="container mt-5 d-flex justify-content-center align-items-center game-container">
    <div class="row justify-content-center">
      <div class="col-md-6 text-center">
        <h2>Snake Game</h2>
        <canvas id="gameCanvas" width="400" height="400"></canvas>
        <div class="mt-3">
          <p id="playerInfo">Playing as: Guest</p>
          <p>Score: <span id="score">0</span> | High Score: <span id="highScore">0</span></p>
          <button id="startButton" class="btn btn-success mb-2">Start Game</button>
          <p>Click Start or canvas to begin!</p>
          <div class="mobile-controls d-md-none">
            <div class="d-flex flex-column align-items-center">
              <button id="upBtn" class="control-btn mb-2">↑</button>
              <div class="d-flex justify-content-center align-items-center">
                <button id="leftBtn" class="control-btn me-4">←</button>
                <button id="downBtn" class="control-btn mx-2">↓</button>
                <button id="rightBtn" class="control-btn ms-4">→</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-md-6">
        <div class="leaderboard">
          <h3>Leaderboard</h3>
          <div id="leaderboardLoading">Loading scores...</div>
          <table id="leaderboardTable" class="leaderboard-table" style="display: none;">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Player</th>
                <th>Score</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody">
              <!-- Leaderboard entries will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { supabase, getCurrentUser } from './auth.js';
    
    // Make supabase available to non-module scripts
    window.supabaseAuth = {
      supabase,
      getCurrentUser
    };
    
    // Check for user session
    async function checkUserSession() {
      const { success, user } = await getCurrentUser();
      
      if (success && user) {
        console.log("User is logged in:", user.id);
        localStorage.setItem("user_id", user.id);
        
        // Get username for player info
        let username = user.user_metadata?.username;
        
        // If not in metadata, try localStorage
        if (!username) {
          username = localStorage.getItem("username");
        }
        
        // If still no username, try to fetch from login table
        if (!username) {
          try {
            const { data, error } = await supabase
              .from('login')
              .select('username')
              .eq('user_id', user.id)
              .single();
              
            if (!error && data) {
              username = data.username;
              localStorage.setItem("username", username);
            }
          } catch (err) {
            console.error("Error fetching username:", err);
          }
        }
        
        // Display player info
        if (username) {
          document.getElementById("playerInfo").textContent = `Playing as: ${username}`;
        }
      } else {
        console.log("User is browsing as a guest");
      }
      
      // Load leaderboard after checking user
      loadLeaderboard();
    }
    
    // Load leaderboard data
    async function loadLeaderboard() {
      try {
        const { data, error } = await supabase
          .from('game_scores')
          .select(`
            id,
            user_id,
            score,
            created_at
          `)
          .eq('game_type', 'snake')
          .order('score', { ascending: false })
          .limit(10);
          
        if (error) throw error;
        
        const leaderboardBody = document.getElementById('leaderboardBody');
        const loadingEl = document.getElementById('leaderboardLoading');
        const tableEl = document.getElementById('leaderboardTable');
        
        if (data && data.length > 0) {
          // Clear previous entries
          leaderboardBody.innerHTML = '';
          
          // Get all unique user IDs
          const userIds = [...new Set(data.map(entry => entry.user_id))];
          
          // Fetch usernames for these IDs
          const { data: userData, error: userError } = await supabase
            .from('login')
            .select('user_id, username')
            .in('user_id', userIds);
            
          if (userError) throw userError;
          
          // Create a map of user_id to username
          const usernameMap = {};
          if (userData) {
            userData.forEach(user => {
              usernameMap[user.user_id] = user.username;
            });
          }
          
          // Add each score to the leaderboard
          data.forEach((entry, index) => {
            const username = usernameMap[entry.user_id] || 'Unknown Player';
            const date = new Date(entry.created_at).toLocaleDateString();
            const currentUserId = localStorage.getItem('user_id');
            
            const row = document.createElement('tr');
            // Highlight the user's own score
            if (entry.user_id === currentUserId) {
              row.classList.add('your-score');
            }
            
            row.innerHTML = `
              <td>${index + 1}</td>
              <td>${username}</td>
              <td>${entry.score}</td>
              <td>${date}</td>
            `;
            
            leaderboardBody.appendChild(row);
          });
          
          // Show the table
          loadingEl.style.display = 'none';
          tableEl.style.display = 'table';
        } else {
          loadingEl.textContent = 'No scores yet. Be the first to play!';
        }
      } catch (err) {
        console.error('Error loading leaderboard:', err);
        document.getElementById('leaderboardLoading').textContent = 'Error loading leaderboard.';
      }
    }
    
    // Make loadLeaderboard available globally
    window.loadLeaderboard = loadLeaderboard;
    
    // Run the check when page loads
    checkUserSession();
  </script>
  <script type="module" src="snake.js"></script>
  <script src="scripts.js"></script>
  <script src="navbar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>